P8105\_hw6\_rm3609
================
Runqi Ma
2018/11/26

Problem 1
=========

Create a city\_state variable (e.g. “Baltimore, MD”), and a binary variable indicating whether the homicide is solved. Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO. Also omit Tulsa, AL. Modifiy victim\_race to have categories white and non-white, with white as the reference category. Be sure that victim\_age is numeric.

``` r
homi_data = read_csv("./homicide-data.csv")

homi_data =
  homi_data %>% 
  mutate(city_state = str_c(city, state, sep = ", "),
         homi_solved = if_else(disposition == "Closed by arrest", 1, 0),
         victim_race = if_else(victim_race == "White", "White", "Non-White"),
         victim_race = fct_relevel(victim_race, "White"),
         victim_age = as.numeric(victim_age)) %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")))
```

For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race (as just defined) as predictors. Save the output of glm as an R object; apply the broom::tidy to this object; and obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed.

``` r
bal_logre = 
  homi_data %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(homi_solved ~ victim_age + victim_sex + victim_race, data = . ,family = binomial())

bal_logre %>% 
  broom::tidy(conf.int = TRUE) %>% 
  mutate(OR = exp(estimate),
         conf_low_adj = exp(conf.low),
         conf_high_adj = exp(conf.high)) %>% 
  filter(term == "victim_raceNon-White")
```

    ## # A tibble: 1 x 10
    ##   term  estimate std.error statistic p.value conf.low conf.high    OR
    ##   <chr>    <dbl>     <dbl>     <dbl>   <dbl>    <dbl>     <dbl> <dbl>
    ## 1 vict…   -0.820     0.175     -4.69 2.68e-6    -1.16    -0.479 0.441
    ## # ... with 2 more variables: conf_low_adj <dbl>, conf_high_adj <dbl>

Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims. Do this within a “tidy” pipeline, making use of purrr::map, list columns, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.

``` r
fuc = function(data) {
  broom::tidy(data, conf.int = TRUE)
}
  
each_city = 
  homi_data %>% 
  group_by(city_state) %>% 
  nest() %>%
  mutate(model = map(data, ~glm(homi_solved ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
         model = map(model, fuc)) %>% 
  select(-data) %>%
  unnest() %>% 
  mutate(OR = exp(estimate),
         conf_low_adj = exp(conf.low),
         conf_high_adj = exp(conf.high)) %>% 
  select(city_state, term, OR, conf_low_adj, conf_high_adj) %>% 
  filter(term == "victim_raceNon-White")
```

Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.
